<%      if @container_class.length > 0 %>
void <%= @name %>_vt::operator() (sqlite3_vtab *vtab, sqlite3_vtab_cursor *cur) {
  picoQLTableCursor *stc = (picoQLTableCursor *)cur;
  (void)vtab;
  vector<<%= @signature.chomp('*') %>::iterator *> *res = new vector<<%= @signature.chomp('*') %>::iterator *>();
  stc->resultSet = (void *)res;
  vector<<%= @signature.chomp('*') %>::iterator *>::iterator *resIter = new vector<<%= @signature.chomp('*') %>::iterator *>::iterator();
  dynamic_bitset<unsigned long> *resBts = new dynamic_bitset<unsigned long>(stc->max_size);
  stc->resultSetIndex = (void *)resBts;
  stc->resultSetIterState = -1;
  stc->resultSetIter = (void *)resIter;
}
<%      end %>

int <%= @name %>_vt::operator() (sqlite3_vtab_cursor *cur) {
  picoQLTableCursor *stc = (picoQLTableCursor *)cur;
<%    if @container_class.length > 0 %>
  vector<<%= @signature.chomp('*') %>::iterator *> *res = (vector<<%= @signature.chomp('*') %>::iterator *> *)stc->resultSet;
  vector<<%= @signature.chomp('*') %>::iterator *>::iterator *resIter = (vector<<%= @signature.chomp('*') %>::iterator *>::iterator *)stc->resultSetIter;     
  dynamic_bitset<unsigned long> *resBts = (dynamic_bitset<unsigned long> *)stc->resultSetIndex;
  if ((int)res->size() > 0) {
    if (stc->resultSetIterState == -1) {
      stc->current = (int)resBts->find_first();
      *resIter = res->begin();
      stc->resultSetIterState = 1;
    } else if (stc->resultSetIterState == 1) {
      (*resIter)++;
      stc->current = (int)resBts->find_next(stc->current);
    }
    if (*resIter < res->end()) {
<%      @columns.each_index { |col| %>
<%       if @columns[col].related_to.length > 0 %>
      VtblImpl *chargeVT<%= col %> = selector_vt["<%= @columns[col].related_to %>"];
<%         if @base_var.length == 0 %>
      (*chargeVT<%= col %>)(cur, 1, &charged);
<%         else %>
      map<sqlite3_vtab_cursor *, bool> *map<%= @name %>;
      map<%= @name %> = NULL;
      (*chargeVT<%= col %>)(cur, 1, map<%= @name %>);
<%         end %>
<%       end %>
<%      } %>
      return SQLITE_OK;
    }
  }
  stc->isEof = 1;
  stc->resultSetIterState = -1;
  for (resIterC = res->begin(); resIterC != res->end(); resIterC++)
    delete *resIterC;
  res->clear();
  resBts->clear();
<%    else %>
  stc->current++;
  if (stc->current >= stc->size)
    stc->isEof = 1;
  else {
<%      @columns.each_index { |col| %>
<%       if @columns[col].related_to.length > 0 %>
    VtblImpl *chargeVT<%= col %> = selector_vt["<%= @columns[col].related_to %>"];
<%         if @base_var.length == 0 %>
      (*chargeVT<%= col %>)(cur, 1, &charged);
<%         else %>
      map<sqlite3_vtab_cursor *, map> *map<%= @name %>;
      map<%= @name %> = NULL;
      (*chargeVT<%= col %>)(cur, 1, map<%= @name %>);
<%         end %>
<%       end %>
<%      } %>
  }
<%    end %>
#ifdef PICO_QL_DEBUG
  printf("Table %s, now stc->current: %i \nstc->isEof: %i\n\n",
         st->zName, stc->current, stc->isEof);
#endif
  return SQLITE_OK;
}

void <%= @name %>_vt::operator() (sqlite3_vtab_cursor *cur, void *shadowRes) {
  (void)shadowRes;
<%      if @container_class.length > 0 %>
  picoQLTableCursor *stc = (picoQLTableCursor *)cur;
  vector<<%= @signature.chomp('*') %>::iterator *> *res = (vector<<%= @signature.chomp('*') %>::iterator *> *)stc->resultSet;
  vector<<%= @signature.chomp('*') %>::iterator *>::iterator *resIter = (vector<<%= @signature.chomp('*') %>::iterator *>::iterator *)stc->resultSetIter;     
  dynamic_bitset<unsigned long> *resBts = (dynamic_bitset<unsigned long> *)stc->resultSetIndex;
  for (resIterC = res->begin(); resIterC != res->end(); resIterC++)
    delete *resIterC;
  res->clear();
  delete res;
  delete resIter;
  resBts->clear();
  delete resBts;
<%      end %>
<%      if @base_var.length == 0 %>
  if (!cursors.erase(cur))
    printf("No such cursor %li inserted\n", (long int)cur);
  charged.clear();
  recursive = 0;
<%      else %>
  (void)cur;
<%      end %>
}
